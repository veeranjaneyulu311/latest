import sys
import os
import subprocess as sp
import datetime
import time

#list of services with their respective pid files

services_list={'zuul':['Zuul-EdgeServer-0.0.1-SNAPSHOT.jar','ZullServerService-pid'],'spring-boot-admin':['Spring-Boot-Admin-Server-0.0.1-SNAPSHOT.jar','SpringBootAdmin-pid'],'configserver':['Config-Server-0.0.1-SNAPSHOT.jar','ConfigServerService-pid'],'eureka':['Eureka-Server-0.0.1-SNAPSHOT.jar','EurekaService-pid'],'appointment':['appointment.jar',''],'insurance':['insurance-0.0.1.jar','insurance-pid'],'login':['login-reg-0.0.1.jar','login-Service-pid'],'promosms':['promosms-0.0.1.jar','promosms-pid'],'catalog':['settings-0.0.1.jar','CatalogModule-pid'],'billing':['billing-0.0.1.jar','billingService-pid'],'emr':['emr-0.0.1.jar','emr-pid'],'inventory':['inventory-0.0.1.jar','inventory-pid'],'nursing-care':['nursing-care-0.0.1.jar','NursingCareService-pid'],'quality':['quality.jar','qualityService-pid'],'website-service':['website-services-.0.1.jar','website-services-pid'],'communication':['communication-0.0.1-SNAPSHOT.jar','communicationService-pid'],'erx':['erx.jar','ERXService-pid'],'lab':['lab-0.0.1.jar','lab-pid'],'pharmacy':['pharmacy-0.0.1.jar','pharmacymodule-pid'], 'reports':['report-module-0.0.1.jar','reports-pid'],'practice':['practice.jar','practice-temp'],'ipd':['ipd-0.0.1.jar','ipdService-pid'],'opd':['opd-0.0.1.jar','opdService-pid']}


#list of variables

service_name=sys.argv[1]
service_jar_name=services_list[service_name][0]
today_date=datetime.datetime.now().strftime("%Y-%b-%d")
backup_directory='/opt/app/jarbackup/{}'.format(today_date)
source_location='/opt/app/{}'.format(service_jar_name)
jenkins_deploy_directory='/home/jenkins/deploy/{}'.format(service_jar_name)
destination='/opt/app/'



#This function returns the PID of the given service
def get_pid():
         cmd="ps -eaf|grep "+service_jar_name+"|grep -v grep|awk '{print $2}'"
         return sp.check_output(cmd,shell=True).strip()

#This function stops the given service and removes PID file
def kill_process():
         print('service={}       jar::{}      PID::{}'.format(service_name,service_jar_name,pid))
         print('stopping the service {}'.format(service_name))
         print('killing process')
         sp.call(['kill','-9',pid])
         print('process is killed')
         tmp_file_path='/tmp/{}'.format(services_list[service_name][1])
         if os.path.isfile(tmp_file_path):
                print("removing the pid file {}".format(tmp_file_path))
                sp.call(['rm','-f',tmp_file_path])
         print('{} Service is stopped'.format(service_name))




#It creates backup directory with today's date
def create_backup_directory():
        if (os.path.isdir(backup_directory)==False):
                os.mkdir(backup_directory)




#This function renames recently moved jar in backup directory
def rename_old_jar():
        #get all existing files list
        current_jars=os.listdir(backup_directory)
        #get current given jars
        same_jars=list(filter(lambda file:file.startswith(service_jar_name),current_jars))
        #get recent jar
        recent_jar=list(filter(lambda file:file==service_jar_name,same_jars))
        if len(recent_jar)!=0:
                new='{}/{}.{}'.format(backup_directory,recent_jar[0],len(same_jars)-1)
                sp.call(['mv','{}/{}'.format(backup_directory,service_jar_name),new])
                verify()
        else:
                verify()


#It performs following operations 'taking backup of old jar' and 'running new jar'
def release():
         print("moving {} [{}] from {} to {}".format(service_jar_name,os.path.getsize(source_location),source_location,backup_directory))
         if sp.call(['mv',source_location,backup_directory])==0:
                print("copying {} [{}] from {} to /opt/app".format(service_jar_name,os.path.getsize(jenkins_deploy_directory),jenkins_deploy_directory))
                sp.call(['cp',jenkins_deploy_directory,destination])
                print('starting the {} service'.format(service_name))
                sp.call(['service',service_name,'start'])
                print('started the {} service'.format(service_name))
         else:
                print('failed to move')





#It verifies existence of  jar in /opt/app and /home/jenkins/deploy/
def verify():
        if (os.path.isfile(source_location)):
                if (os.path.isfile(jenkins_deploy_directory)):
                        release()
                else:
                        print('No suchfile or directory::{}'.format(jenkins_deploy_directory))
        else:
                print('No suchfile or directory::{}'.format(source_location))



if services_list.has_key(service_name):
        pid=get_pid()

        #stopping service
        if pid=='':
                print("{} is not running".format(service_name))
        else:
                kill_process()
                time.sleep(6)

        #create backup directory
        create_backup_directory()

        #taking backup
        rename_old_jar()
        new_pid=get_pid()
        if new_pid!='':
                print('service::{}       jar::{}      newPID::{}'.format(service_name,service_jar_name,new_pid))
else:
        print('no such service')
        print('Avilable services are:')
        print('\n'.join( services_list.keys()))


